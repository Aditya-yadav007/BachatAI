<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <h2>BachatAI</h2>
            </div>
    <!-- Imports Drawer and Backdrop -->
    <div id="importsBackdrop" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;" onclick="closeImportsModal()"></div>
    <div id="importsDrawer" style="display:none; position: fixed; top: 0; right: 0; height: 100%; width: 420px; background: #ffffff; z-index: 1000; box-shadow: -6px 0 16px rgba(0,0,0,0.15); overflow: auto; padding: 16px;">
        <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin:0;">Uploaded Imports</h3>
            <button class="reset-btn" onclick="closeImportsModal()">Close</button>
        </div>
        <div id="importsList" class="suggestion-box" style="margin:0;">
            <h3 class="suggestion-title">üì¶ Your Uploaded Files</h3>
            <div id="importsItems" style="padding: 8px 12px;">Loading...</div>
        </div>
    </div>
        </div>
        <nav class="nav-menu">
            <button class="nav-item active" data-section="transactions"><i
                    class="fas fa-exchange-alt"></i><span>Transactions</span></button>
            <button class="nav-item" data-section="savings"><i
                    class="fas fa-piggy-bank"></i><span>Savings</span></button>
            <button class="nav-item" data-section="analytics"><i
                    class="fas fa-chart-line"></i><span>Analytics</span></button>
            <button class="nav-item" data-section="investment"><i
                    class="fas fa-chart-pie"></i><span>Investment</span></button>
            <button class="nav-item" data-section="credit-score"><i class="fas fa-credit-card"></i><span>Credit Score
                    Simulation</span></button>
            <button class="nav-item" data-section="cash-flow"><i class="fas fa-money-bill-wave"></i><span>Cash Flow
                    Prediction</span></button>
            <button class="nav-item" data-section="emergency-fund"><i class="fas fa-shield-alt"></i><span>Emergency
                    Fund</span></button>
            <button class="nav-item" data-section="growth"><i class="fas fa-seedling"></i><span>Growth</span></button>
            <button class="nav-item" onclick="window.location.href='usernotification.html'"><i
                    class="fas fa-bell"></i><span>Notification</span></button>
            <button class="nav-item" onclick="window.location.href='support.html'"><i
                    class="fas fa-headset"></i><span>Support</span></button>
        </nav>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="hamburger" id="hamburger">‚ò∞</button>
        <h1>Financial Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 8px;">
            <button class="reset-btn" onclick="resetFilters()">Reset Filters</button>
            <button class="reset-btn" onclick="openImportsModal()">View Imports</button>
            <div class="profile-container">
                <button class="profile-btn" onclick="toggleProfileDropdown()">U</button>
                <div class="profile-dropdown" id="profileDropdown">
                    <button class="dropdown-item" onclick="window.location.href='index.html'">Profile</button>
                    <button class="dropdown-item" onclick="triggerTransactionsUpload()">Upload Statement</button>
                    <button class="dropdown-item" onclick="handleLogout()">Logout</button>
                </div>
                <input id="transactionFileInput" type="file" accept=".csv,.xlsx,.xls,.json,.pdf" style="display:none"
                    onchange="onTransactionFileSelected(event)" />
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- KPI Cards (Always Visible) -->
        <div class="kpi-container">
            <div class="kpi-card">
                <div class="kpi-title">Transactions</div>
                <div class="kpi-value" id="transactions-value">1,200+</div>
                <div class="kpi-change positive">this year</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Savings</div>
                <div class="kpi-value" id="savings-value">$45,000</div>
                <div class="kpi-change positive">+12.5% from last month</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Investments</div>
                <div class="kpi-value" id="investments-value">$120,000</div>
                <div class="kpi-change positive">+8.3% from last month</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Credit Score</div>
                <div class="kpi-value" id="credit-score-value">720</div>
                <div class="kpi-change positive">+15 points this month</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Net Cash Flow</div>
                <div class="kpi-value" id="cash-flow-value">$8,500</div>
                <div class="kpi-change positive">+22.1% from last month</div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="content-section active" id="transactions">
            <h2 class="section-title">Transactions Overview</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Monthly Transaction Trends</h3>
                    <div class="chart-container">
                        <canvas id="transactionsChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Transaction Categories</h3>
                    <div class="chart-container">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Transactions -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üí° Smart Suggestions</h3>
                <p class="suggestion-content">Based on your transaction patterns, here are some recommendations to
                    optimize your spending:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>You spent 35% on dining out this month. Consider meal planning to reduce costs by $200-300.
                        </div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Set up automatic bill payments to avoid late fees and improve your credit score.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Use cashback credit cards for shopping to earn 2-3% rewards on purchases.</div>
                    </li>
                </ul>
            </div>
            <div id="analysisResultContainer" class="suggestion-box">
                <h3 class="suggestion-title">üîç Statement Analysis Result</h3>
                <pre id="analysisResult" style="white-space: pre-wrap;"></pre>
            </div>
        </div>

        <!-- Savings Section -->
        <div class="content-section" id="savings">
            <h2 class="section-title">Savings Growth</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Savings Growth Over Time</h3>
                    <div class="chart-container">
                        <canvas id="savingsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Savings -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üí∞ Savings Optimization</h3>
                <p class="suggestion-content">Your savings are growing well! Here's how to accelerate your progress:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Increase your savings rate to 25% of income to reach goals 6 months faster.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Consider high-yield savings accounts offering 4.5% APY instead of traditional 0.5%.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Automate savings transfers on payday to maintain consistency.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="content-section" id="analytics">
            <h2 class="section-title">Financial Analytics</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Income vs Expenses</h3>
                    <div class="chart-container">
                        <canvas id="incomeExpensesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Analytics -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üìä Financial Insights</h3>
                <p class="suggestion-content">Your financial analytics reveal key opportunities for improvement:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Your expense ratio is 75%. Aim for 70% or lower to increase savings potential.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Variable expenses fluctuate by 15%. Create a monthly budget to stabilize spending.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Consider the 50/30/20 rule: 50% needs, 30% wants, 20% savings.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Investment Section -->
        <div class="content-section" id="investment">
            <h2 class="section-title">Investment Portfolio</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Investment Allocation</h3>
                    <div class="chart-container">
                        <canvas id="investmentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Investment -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üìà Investment Strategy</h3>
                <p class="suggestion-content">Your portfolio is well-diversified! Consider these optimization
                    strategies:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Rebalance quarterly to maintain target allocation and reduce risk.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Consider increasing bond allocation as you approach retirement age.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Dollar-cost averaging into index funds can reduce volatility impact.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Credit Score Section -->
        <div class="content-section" id="credit-score">
            <h2 class="section-title">Credit Score Simulation</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Credit Score Trends</h3>
                    <div class="chart-container">
                        <canvas id="creditScoreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Credit Score -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üéØ Credit Score Improvement</h3>
                <p class="suggestion-content">Your credit score is in good range! Here's how to reach excellent (750+):
                </p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Keep credit utilization below 10% to potentially gain 20-30 points.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Pay all bills on time for the next 6 months to see consistent improvement.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Consider becoming an authorized user on a family member's old account.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Cash Flow Section -->
        <div class="content-section" id="cash-flow">
            <h2 class="section-title">Cash Flow Prediction</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Cash Flow Waterfall</h3>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Cash Flow -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üí∏ Cash Flow Optimization</h3>
                <p class="suggestion-content">Your cash flow is positive! Here are ways to maximize it:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Negotiate bills (phone, internet, insurance) to save $100-200 monthly.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Consider a side income stream to boost monthly cash flow by $500-1000.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Review subscriptions and cancel unused services to free up $50-100 monthly.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Emergency Fund Section -->
        <div class="content-section" id="emergency-fund">
            <h2 class="section-title">Emergency Fund</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Emergency Fund Progress</h3>
                    <div class="chart-container">
                        <canvas id="emergencyFundChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Emergency Fund -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üõ°Ô∏è Emergency Fund Strategy</h3>
                <p class="suggestion-content">You're 75% towards your emergency fund goal! Final push recommendations:
                </p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Increase monthly contributions by $200 to reach your goal 2 months earlier.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Keep emergency funds in high-yield savings for easy access and growth.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Once complete, redirect contributions to investment accounts for higher returns.</div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Growth Section -->
        <div class="content-section" id="growth">
            <h2 class="section-title">Financial Growth</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Net Worth Growth</h3>
                    <div class="chart-container">
                        <canvas id="netWorthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Suggestions for Growth -->
            <div class="suggestion-box">
                <h3 class="suggestion-title">üöÄ Wealth Growth Acceleration</h3>
                <p class="suggestion-content">Your net worth is growing steadily! Accelerate with these strategies:</p>
                <ul class="suggestion-list">
                    <li class="suggestion-item">
                        <div class="suggestion-icon">1</div>
                        <div>Increase investment contributions by 5% to compound wealth faster.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">2</div>
                        <div>Consider tax-advantaged accounts (401k, IRA) to reduce tax burden.</div>
                    </li>
                    <li class="suggestion-item">
                        <div class="suggestion-icon">3</div>
                        <div>Diversify into real estate or REITs for additional income streams.</div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script >

        // NOTE: Paste your real Firebase config here. The placeholders below will prevent auth from working.
        // If you see the warning in console about placeholder config, update these values from your Firebase Console.
        // Firebase Configuration (Replace with your config)
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        if (firebaseConfig && firebaseConfig.apiKey === 'your-api-key') {
            console.warn('Firebase config is using placeholder values. Auth will be unavailable until real config is provided.');
        }
        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Global variables
        let charts = {};
        let financialData = {};

        // Demo data
        const demoData = {
            transactions: 1200,
            savings: 45000,
            investments: 120000,
            creditScore: 720,
            netCashFlow: 8500,
            monthlyTransactions: [95, 110, 125, 140, 135, 150, 165, 155, 170, 180, 175, 190],
            monthlySavings: [2500, 2800, 3200, 3500, 3800, 4200, 4500, 4800, 5200, 5500, 5800, 6000],
            monthlyIncome: [8500, 8500, 8500, 8500, 8500, 8500, 8500, 8500, 8500, 8500, 8500, 8500],
            monthlyExpenses: [6200, 6400, 6100, 6300, 6500, 6200, 6400, 6300, 6100, 6200, 6300, 6400],
            investmentAllocation: [45000, 30000, 25000, 20000],
            creditScoreHistory: [680, 690, 695, 705, 710, 715, 720],
            emergencyFundContributions: [500, 600, 700, 800, 750, 900, 850, 950, 1000, 1100, 1200, 1150],
            netWorthHistory: [150000, 165000, 180000, 195000, 210000, 225000, 240000, 255000, 270000, 285000, 300000, 315000]
        };

        // Mobile menu toggle
        document.getElementById('hamburger').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-visible');
        });

        // Navigation functionality
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');

                // Hide all content sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Show selected section
                const sectionId = this.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');

                // Hide sidebar on mobile after selection
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('mobile-visible');
                }

                // Load charts for the selected section
                loadChartsForSection(sectionId);

                // Load notifications content if notifications section is selected
                if (sectionId === 'notifications') {
                    loadNotificationsContent();
                }
            });
        });

        // Reset filters function
        function resetFilters() {
            console.log('Resetting all filters...');
            loadFinancialData();
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Update KPI cards
        function updateKPICards(data) {
            document.getElementById('transactions-value').textContent = data.transactions + '+';
            document.getElementById('savings-value').textContent = formatCurrency(data.savings);
            document.getElementById('investments-value').textContent = formatCurrency(data.investments);
            document.getElementById('credit-score-value').textContent = data.creditScore;
            document.getElementById('cash-flow-value').textContent = formatCurrency(data.netCashFlow);
        }

        // Load charts for specific section
        function loadChartsForSection(sectionId) {
            switch (sectionId) {
                case 'transactions':
                    createTransactionsChart();
                    createCategoriesChart();
                    break;
                case 'savings':
                    createSavingsChart();
                    break;
                case 'analytics':
                    createIncomeExpensesChart();
                    break;
                case 'investment':
                    createInvestmentChart();
                    break;
                case 'credit-score':
                    createCreditScoreChart();
                    break;
                case 'cash-flow':
                    createCashFlowChart();
                    break;
                case 'emergency-fund':
                    createEmergencyFundChart();
                    break;
                case 'growth':
                    createNetWorthChart();
                    break;
            }
        }

        // Load financial data from Firebase or demo
        async function loadFinancialData() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.log('User not authenticated, using demo data');
                    financialData = demoData;
                    updateKPICards(financialData);
                    loadChartsForSection('transactions'); // Load initial charts
                    return;
                }

                const docRef = db.collection('financialData').doc(user.uid);
                const doc = await docRef.get();

                if (doc.exists) {
                    financialData = doc.data();
                } else {
                    console.log('No financial data found, using demo data');
                    financialData = demoData;
                }

                updateKPICards(financialData);
                loadChartsForSection('transactions');
            } catch (error) {
                console.error('Error loading financial data:', error);
                financialData = demoData;
                updateKPICards(financialData);
                loadChartsForSection('transactions');
            }
        }

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                loadFinancialData();
            } else {
                console.log('User not authenticated, using demo data');
                loadFinancialData();
            }
        });

        // Profile dropdown functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Upload transactions handlers
        function triggerTransactionsUpload() {
            const input = document.getElementById('transactionFileInput');
            if (input) {
                input.value = '';
                input.click();
            }
        }

        // Parsing helpers
        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: results => resolve(results.data || []),
                    error: err => reject(err)
                });
            });
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                        resolve(json);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = err => reject(err);
                reader.readAsArrayBuffer(file);
            });
        }

        function parseJsonFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const json = JSON.parse(e.target.result);
                        resolve(json);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = err => reject(err);
                reader.readAsText(file);
            });
        }

        async function parsePdfFile(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const pages = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const strings = content.items.map(item => item.str);
                const text = strings.join(' ');
                pages.push({ page: i, text });
            }
            return { pages };
        }

        async function onTransactionFileSelected(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;

            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.remove('show');

            const name = file.name;
            const ext = name.split('.').pop().toLowerCase();

            try {
                let parsedData;
                if (ext === 'csv') {
                    parsedData = await parseCSVFile(file);
                } else if (ext === 'xlsx' || ext === 'xls') {
                    parsedData = await parseExcelFile(file);
                } else if (ext === 'json') {
                    parsedData = await parseJsonFile(file);
                } else if (ext === 'pdf') {
                    parsedData = await parsePdfFile(file);
                } else {
                    alert('Unsupported file type. Please upload CSV, XLSX, XLS, JSON, or PDF.');
                    return;
                }

                console.log('Parsed transactions:', parsedData);
                await handleParsedTransactions(parsedData, file);
            } catch (err) {
                console.error('Error parsing transactions file:', err);
                alert('Failed to parse file. Please check format and try again.');
            }
        }

        async function uploadParsedTransactionsToFirebase(parsedData, file) {
            const user = auth.currentUser;
            if (!user) {
                console.warn('No authenticated user. Using demo mode, not saving to Firestore.');
                return null;
            }

            const docRef = db.collection('transactionImports').doc();
            const payload = {
                userId: user.uid,
                originalFileName: file.name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                rawData: parsedData
            };
            await docRef.set(payload);
            return { id: docRef.id, ...payload };
        }

        async function handleParsedTransactions(parsedData, file) {
            // Upload (best-effort) and run analysis, but always show parsed data preview regardless of auth state
            let savedMeta = null;
            try {
                savedMeta = await uploadParsedTransactionsToFirebase(parsedData, file);
            } catch (e) {
                console.warn('Upload to Firestore failed or skipped:', e);
            }

            let analysis = null;
            try {
                analysis = await runAnalysisModel(parsedData, savedMeta);
            } catch (e) {
                console.warn('Analysis model failed:', e);
            }

            const payloadToShow = {
                analysis,
                dataPreview: buildDataPreview(parsedData, 20)
            };

            const analysisResultEl = document.getElementById('analysisResult');
            if (analysisResultEl) {
                analysisResultEl.textContent = JSON.stringify(payloadToShow, null, 2);
            }
            alert('Statement uploaded and analyzed successfully.');
        }

        function buildDataPreview(parsedData, limit = 20) {
            // CSV/Excel/JSON arrays
            if (Array.isArray(parsedData)) {
                return parsedData.slice(0, limit);
            }
            // PDF structure { pages: [...] }
            if (parsedData && Array.isArray(parsedData.pages)) {
                const pageLimit = Math.max(1, Math.min(parsedData.pages.length, 5));
                return { pages: parsedData.pages.slice(0, pageLimit) };
            }
            // Fallback: return as-is
            return parsedData;
        }

        async function runAnalysisModel(parsedData, meta) {
            console.log('Running analysis model with:', { parsedData, meta });
            const recordsCount = Array.isArray(parsedData) ? parsedData.length : (parsedData && parsedData.pages ? parsedData.pages.length : null);
            return {
                status: 'success',
                message: 'Mock analysis complete (replace with real model).',
                recordsCount,
                fileName: meta ? meta.originalFileName : null,
                importId: meta ? meta.id : null
            };
        }

        // Imports drawer helpers
        function openImportsModal() {
            const backdrop = document.getElementById('importsBackdrop');
            const drawer = document.getElementById('importsDrawer');
            if (backdrop && drawer) {
                backdrop.style.display = 'block';
                drawer.style.display = 'block';
                loadImportsList();
            }
        }

        function closeImportsModal() {
            const backdrop = document.getElementById('importsBackdrop');
            const drawer = document.getElementById('importsDrawer');
            if (backdrop && drawer) {
                backdrop.style.display = 'none';
                drawer.style.display = 'none';
            }
        }

        async function loadImportsList() {
            const container = document.getElementById('importsItems');
            if (!container) return;
            container.textContent = 'Loading...';

            const user = auth.currentUser;
            if (!user) {
                container.textContent = 'You are not signed in. Sign in to view your uploaded imports.';
                return;
            }

            try {
                const snapshot = await db.collection('transactionImports')
                    .where('userId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    container.textContent = 'No uploads found yet.';
                    return;
                }

                const frag = document.createDocumentFragment();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
                    const raw = data.rawData;
                    const count = Array.isArray(raw) ? raw.length : (raw && raw.pages ? raw.pages.length : null);

                    const item = document.createElement('div');
                    item.style.borderBottom = '1px solid #e5e7eb';
                    item.style.padding = '10px 0';
                    item.innerHTML = `
                        <div style="display:flex; justify-content: space-between; align-items:center; gap:8px;">
                            <div>
                                <div style="font-weight:600;">${data.originalFileName || 'Unnamed file'}</div>
                                <div style="font-size:12px; color:#64748b;">${createdAt ? createdAt.toLocaleString() : 'Pending timestamp'}</div>
                                <div style="font-size:12px; color:#64748b;">Records: ${count ?? 'N/A'}</div>
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="reset-btn" style="padding:6px 10px;" onclick="viewImportJson('${doc.id}')">View JSON</button>
                            </div>
                        </div>
                    `;
                    frag.appendChild(item);
                });
                container.innerHTML = '';
                container.appendChild(frag);
            } catch (err) {
                console.error('Failed to load imports:', err);
                container.textContent = 'Failed to load imports.';
            }
        }

        async function viewImportJson(docId) {
            try {
                const docRef = db.collection('transactionImports').doc(docId);
                const snap = await docRef.get();
                if (!snap.exists) return;
                const data = snap.data();
                const analysisResultEl = document.getElementById('analysisResult');
                if (analysisResultEl) {
                    analysisResultEl.textContent = JSON.stringify(data.rawData, null, 2);
                }
            } catch (err) {
                console.error('Failed to view JSON:', err);
            }
        }

        function openProfile() {
            console.log('Opening profile...');
            // Add profile functionality here
            toggleProfileDropdown();
        }

        function logout() {
            console.log('Logging out...');
            auth.signOut().then(() => {
                console.log('User signed out successfully');
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
            toggleProfileDropdown();
        }

        function handleLogout() {
            logout();
        }

        // Function to load notifications content
        async function loadNotificationsContent() {
            const notificationsContainer = document.getElementById('notifications-content');

            try {
                // Show loading state
                notificationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3498db; margin-bottom: 20px;"></i>
                        <p>Loading notifications...</p>
                    </div>
                `;

                // Fetch the notification.html content
                const response = await fetch('../admin_page/notification.html');
                if (!response.ok) {
                    throw new Error('Failed to load notifications');
                }

                const htmlContent = await response.text();

                // Parse the HTML and extract the body content
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');

                // Extract the main content (everything inside body, excluding head)
                const bodyContent = doc.body.innerHTML;

                // Create a container with the notification styles
                notificationsContainer.innerHTML = `
                    <style>
                        /* Notification styles from the original file */
                        .notifications-wrapper * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        .notifications-wrapper {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: white;
                            border-radius: 15px;
                            padding: 20px;
                        }
                        
                        .notifications-wrapper .container {
                            max-width: 100%;
                            margin: 0;
                        }
                        
                        .notifications-wrapper .header {
                            background: white;
                            padding: 20px 0;
                            border-radius: 0;
                            box-shadow: none;
                            margin-bottom: 20px;
                            text-align: center;
                            border-bottom: 2px solid #e74c3c;
                        }
                        
                        .notifications-wrapper .header h1 {
                            color: #2c3e50;
                            font-size: 2rem;
                            font-weight: 700;
                            margin-bottom: 10px;
                        }
                        
                        .notifications-wrapper .header p {
                            color: #7f8c8d;
                            font-size: 1rem;
                        }
                        
                        .notifications-wrapper .notifications-container {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                        }
                        
                        .notifications-wrapper .notification-card {
                            background: white;
                            border: 1px solid #e0e0e0;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
                            transition: all 0.3s ease;
                            position: relative;
                            overflow: hidden;
                        }
                        
                        .notifications-wrapper .notification-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                        }
                        
                        .notifications-wrapper .notification-header {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 15px;
                        }
                        
                        .notifications-wrapper .notification-icon {
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.5rem;
                            color: white;
                            margin-right: 15px;
                        }
                        
                        .notifications-wrapper .notification-content h3 {
                            color: #2c3e50;
                            font-size: 1.2rem;
                            font-weight: 600;
                            margin-bottom: 8px;
                        }
                        
                        .notifications-wrapper .notification-content p {
                            color: #5a6c7d;
                            line-height: 1.6;
                            margin-bottom: 15px;
                        }
                        
                        .notifications-wrapper .notification-time {
                            color: #95a5a6;
                            font-size: 0.9rem;
                            font-weight: 500;
                        }
                        
                        .notifications-wrapper .notification-actions {
                            display: flex;
                            gap: 10px;
                            margin-top: 15px;
                        }
                        
                        .notifications-wrapper .btn {
                            padding: 8px 16px;
                            border: none;
                            border-radius: 6px;
                            font-size: 0.9rem;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }
                        
                        .notifications-wrapper .btn-primary {
                            background: #3498db;
                            color: white;
                        }
                        
                        .notifications-wrapper .btn-primary:hover {
                            background: #2980b9;
                        }
                        
                        .notifications-wrapper .btn-secondary {
                            background: #ecf0f1;
                            color: #2c3e50;
                        }
                        
                        .notifications-wrapper .btn-secondary:hover {
                            background: #d5dbdb;
                        }
                        
                        .notifications-wrapper .priority-high {
                            border-left: 5px solid #e74c3c;
                        }
                        
                        .notifications-wrapper .priority-medium {
                            border-left: 5px solid #f39c12;
                        }
                        
                        .notifications-wrapper .priority-low {
                            border-left: 5px solid #27ae60;
                        }
                        
                        .notifications-wrapper .icon-success { background: #27ae60; }
                        .notifications-wrapper .icon-warning { background: #f39c12; }
                        .notifications-wrapper .icon-error { background: #e74c3c; }
                        .notifications-wrapper .icon-info { background: #3498db; }
                        .notifications-wrapper .icon-security { background: #9b59b6; }
                    </style>
                    <div class="notifications-wrapper">
                        ${bodyContent}
                    </div>
                `;

                // Add event listeners for notification actions
                addNotificationEventListeners();

            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 20px;"></i>
                        <h3>Failed to Load Notifications</h3>
                        <p>Unable to load notification content. Please try again later.</p>
                        <button onclick="loadNotificationsContent()" style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Add event listeners for notification actions
        function addNotificationEventListeners() {
            // Add click handlers for notification buttons
            document.querySelectorAll('.notifications-wrapper .btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const action = this.textContent.trim();
                    const notificationCard = this.closest('.notification-card');

                    if (action === 'Mark as Read' || action === 'Dismiss') {
                        notificationCard.style.opacity = '0.5';
                        notificationCard.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            notificationCard.style.display = 'none';
                        }, 300);
                    } else if (action === 'View Details' || action === 'Review') {
                        alert('Notification details would be shown here.');
                    } else if (action === 'Take Action') {
                        alert('Action would be performed here.');
                    }
                });
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const profileContainer = document.querySelector('.profile-container');
            const dropdown = document.getElementById('profileDropdown');

            if (!profileContainer.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadFinancialData();

            // Handle window resize
            window.addEventListener('resize', function () {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            });
        });

        // Chart creation functions
        function createTransactionsChart() {
            const ctx = document.getElementById('transactionsChart').getContext('2d');
            if (charts.transactions) charts.transactions.destroy();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            charts.transactions = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Transactions',
                        data: financialData.monthlyTransactions,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Transactions' } }
                    }
                }
            });
        }

        function createCategoriesChart() {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            if (charts.categories) charts.categories.destroy();

            charts.categories = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Food & Dining', 'Shopping', 'Transportation', 'Bills', 'Entertainment', 'Other'],
                    datasets: [{
                        data: [35, 25, 15, 20, 10, 5],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function createSavingsChart() {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            if (charts.savings) charts.savings.destroy();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            charts.savings = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Savings',
                        data: financialData.monthlySavings,
                        backgroundColor: '#10b981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Savings ($)' } }
                    }
                }
            });
        }

        function createIncomeExpensesChart() {
            const ctx = document.getElementById('incomeExpensesChart').getContext('2d');
            if (charts.incomeExpenses) charts.incomeExpenses.destroy();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            charts.incomeExpenses = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Income',
                            data: financialData.monthlyIncome,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Expenses',
                            data: financialData.monthlyExpenses,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Amount ($)' } }
                    }
                }
            });
        }

        function createInvestmentChart() {
            const ctx = document.getElementById('investmentChart').getContext('2d');
            if (charts.investment) charts.investment.destroy();

            charts.investment = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Stocks', 'Bonds', 'ETFs', 'Crypto'],
                    datasets: [{
                        data: financialData.investmentAllocation,
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function createCreditScoreChart() {
            const ctx = document.getElementById('creditScoreChart').getContext('2d');
            if (charts.creditScore) charts.creditScore.destroy();

            const months = ['6 months ago', '5 months ago', '4 months ago', '3 months ago', '2 months ago', 'Last month', 'Current'];

            charts.creditScore = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Credit Score',
                        data: financialData.creditScoreHistory,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 600, max: 800, title: { display: true, text: 'Credit Score' } }
                    }
                }
            });
        }

        function createCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            if (charts.cashFlow) charts.cashFlow.destroy();

            charts.cashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Starting Balance', 'Income', 'Fixed Expenses', 'Variable Expenses', 'Savings', 'Ending Balance'],
                    datasets: [{
                        label: 'Cash Flow',
                        data: [5000, 8500, -4200, -2000, -1500, 5800],
                        backgroundColor: ['#6b7280', '#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { title: { display: true, text: 'Amount ($)' } }
                    }
                }
            });
        }

        function createEmergencyFundChart() {
            const ctx = document.getElementById('emergencyFundChart').getContext('2d');
            if (charts.emergencyFund) charts.emergencyFund.destroy();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            charts.emergencyFund = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Contributions',
                        data: financialData.emergencyFundContributions,
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Contribution ($)' } }
                    }
                }
            });
        }

        function createNetWorthChart() {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            if (charts.netWorth) charts.netWorth.destroy();

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            charts.netWorth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Net Worth',
                        data: financialData.netWorthHistory,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Net Worth ($)' } }
                    }
                }
            });
        }

        // Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function handleLogout() {
            const confirmLogout = confirm('Are you sure you want to logout?');

            if (confirmLogout) {
                localStorage.removeItem('loggedInUserId');
                // Redirect to main index page
                window.location.href = '../index.html';
            }
        }
    </script>
</body>

</html>